#include <stdio.h>
#include <string.h>

#define N 5
#define LEN 30
#define FILE_NAME "product.txt"

typedef struct {
    int id;
    char name[LEN];
    int price;
    int stock;   // 현재 재고
    int in;      // 입고량 누적
    int sold;    // 판매량 누적
} Product;

void saveProducts(Product items[], int count) {
    FILE *fp = fopen(FILE_NAME, "w");
    if (!fp) {
        printf("❌ 파일 저장 실패!\n");
        return;
    }

    for (int i = 0; i < count; i++) {
        fprintf(fp, "%d %s %d %d %d %d\n",
                items[i].id,
                items[i].name,
                items[i].price,
                items[i].stock,
                items[i].in,
                items[i].sold);
    }

    fclose(fp);
    printf("✅ 상품정보가 '%s' 파일에 저장되었습니다.\n", FILE_NAME);
}

int loadProducts(Product items[]) {
    FILE *fp = fopen(FILE_NAME, "r");
    if (!fp) {
        printf("⚠️ 저장된 상품정보 파일이 없습니다.\n");
        return 0;
    }

    int count = 0;
    while (fscanf(fp, "%d %s %d %d %d %d",
                  &items[count].id,
                  items[count].name,
                  &items[count].price,
                  &items[count].stock,
                  &items[count].in,
                  &items[count].sold) == 6) {
        count++;
        if (count >= N) break;
    }

    fclose(fp);
    printf("✅ '%s' 파일에서 %d개의 상품정보를 불러왔습니다.\n", FILE_NAME, count);
    return count;
}

int main() {
    Product items[N] = {0};
    int count = 0;
    int menu;

    // 프로그램 시작 시 자동으로 상품정보 불러오기
    count = loadProducts(items);

    while (1) {
        printf("\n[쇼핑몰 재고 관리 시스템]\n");
        printf("1. 입고  2. 판매  3. 개별현황  4. 전체현황  5. 상품정보 저장  6. 상품정보 불러오기  7. 종료\n");
        printf("원하는 메뉴를 선택하세요: ");
        scanf("%d", &menu);

        if (menu == 1) {  // 입고
            int id, qty, price;
            char name[LEN];

            printf("상품 ID 입력(1~%d): ", N);
            scanf("%d", &id);

            int found = -1;
            for (int i = 0; i < count; i++) {
                if (items[i].id == id)
                    found = i;
            }

            if (found != -1) {
                printf("기존 상품입니다. 입고 수량 입력: ");
                scanf("%d", &qty);
                items[found].in += qty;
                items[found].stock += qty;
                printf("✅ %s 재고가 업데이트되었습니다. (현재 재고: %d)\n", items[found].name, items[found].stock);
            } else {
                if (count >= N) {
                    printf("❌ 상품 개수 초과! (최대 %d개 등록 가능)\n", N);
                    continue;
                }
                printf("상품명 입력: ");
                scanf("%s", name);
                printf("입고 수량 입력: ");
                scanf("%d", &qty);
                printf("판매 가격 입력: ");
                scanf("%d", &price);

                items[count].id = id;
                strcpy(items[count].name, name);
                items[count].price = price;
                items[count].in = qty;
                items[count].stock = qty;
                items[count].sold = 0;
                count++;

                printf("✅ 신규 상품 등록 완료! (총 %d/%d)\n", count, N);
            }

        } else if (menu == 2) {  // 판매
            int id, qty;
            printf("상품 ID 입력: ");
            scanf("%d", &id);

            int found = -1;
            for (int i = 0; i < count; i++) {
                if (items[i].id == id)
                    found = i;
            }

            if (found == -1) {
                printf("❌ 해당 상품이 존재하지 않습니다.\n");
            } else {
                printf("판매 수량 입력: ");
                scanf("%d", &qty);
                if (qty > items[found].stock) {
                    printf("❌ 재고 부족! (현재 재고: %d)\n", items[found].stock);
                } else {
                    items[found].sold += qty;
                    items[found].stock -= qty;
                    printf("✅ 판매 완료! 남은 재고: %d\n", items[found].stock);
                }
            }

        } else if (menu == 3) {  // 개별현황
            int id;
            printf("상품 ID 입력: ");
            scanf("%d", &id);

            int found = -1;
            for (int i = 0; i < count; i++) {
                if (items[i].id == id)
                    found = i;
            }

            if (found == -1) {
                printf("❌ 해당 상품이 존재하지 않습니다.\n");
            } else {
                printf("\n[개별 상품 현황]\n");
                printf("ID: %d | 상품명: %s | 가격: %d | 입고량: %d | 판매량: %d | 재고: %d | 총판매금액: %d\n",
                    items[found].id,
                    items[found].name,
                    items[found].price,
                    items[found].in,
                    items[found].sold,
                    items[found].stock,
                    items[found].sold * items[found].price);
            }

        } else if (menu == 4) {  // 전체현황
            printf("\n[전체 상품 현황]\n");
            printf("ID\t상품명\t가격\t입고\t판매\t재고\t총판매금액\t판매율(%%)\n");
            for (int i = 0; i < count; i++) {
                int total = items[i].in;
                double rate = (total > 0) ? (double)items[i].sold / total * 100 : 0.0;
                printf("%d\t%s\t%d\t%d\t%d\t%d\t%d\t%.2f%%\n",
                    items[i].id,
                    items[i].name,
                    items[i].price,
                    items[i].in,
                    items[i].sold,
                    items[i].stock,
                    items[i].sold * items[i].price,
                    rate);
            }

        } else if (menu == 5) {  // 상품정보 저장
            saveProducts(items, count);

        } else if (menu == 6) {  // 상품정보 불러오기
            count = loadProducts(items);

        } else if (menu == 7) {
            printf("프로그램을 종료합니다.\n");
            break;
        } else {
            printf("❌ 잘못된 메뉴입니다. 다시 입력하세요.\n");
        }
    }

    return 0;
}
